<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Controle de Gastos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🤖</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🤖 Dashboard - Controle de Gastos</h1>
            <p class="subtitle">Acompanhe seus gastos de forma inteligente</p>
        </header>
        
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-icon">💰</div>
                <div class="stat-content">
                    <div class="stat-value">R$ {{ "%.2f"|format(gastos_mes_atual) }}</div>
                    <div class="stat-label">Gasto este mês</div>
                </div>
            </div>
            
            <div class="stat-card secondary">
                <div class="stat-icon">📊</div>
                <div class="stat-content">
                    <div class="stat-value">R$ {{ "%.2f"|format(total_geral) }}</div>
                    <div class="stat-label">Total geral</div>
                </div>
            </div>
            
            <div class="stat-card tertiary">
                <div class="stat-icon">📝</div>
                <div class="stat-content">
                    <div class="stat-value">{{ gastos|length }}</div>
                    <div class="stat-label">Total de gastos</div>
                </div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="card chart-card">
                <div class="card-header">
                    <h2>📂 Gastos por Categoria</h2>
                </div>
                <div class="card-content">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            
            <div class="card chart-card">
                <div class="card-header">
                    <h2>🛒 Produtos Mais Gastos</h2>
                </div>
                <div class="card-content">
                    <canvas id="productsChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="content-grid">
            <div class="card">
                <div class="card-header">
                    <h2>📋 Últimos Gastos</h2>
                </div>
                <div class="card-content">
                    {% if gastos %}
                        {% for gasto in gastos[-10:] %}
                        <div class="expense-item">
                            <div class="expense-info">
                                <span class="expense-description">{{ gasto.get('Descrição', 'N/A') }}</span>
                                <span class="expense-date">{{ gasto.get('Data', 'N/A') }}</span>
                            </div>
                            <div class="expense-details">
                                <span class="expense-value">R$ {{ gasto.get('Valor', '0') }}</span>
                                <span class="expense-category">{{ gasto.get('Categoria', 'outros').title() }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="empty-state">Nenhum gasto registrado ainda.</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>🔗 Links Úteis</h2>
                </div>
                <div class="card-content">
                    <div class="links-grid">
                        <a href="https://docs.google.com/spreadsheets/d/{{ sheet_id }}/edit" target="_blank" class="link-button primary">
                            📊 Abrir Planilha Completa
                        </a>
                        <button onclick="location.reload()" class="link-button secondary">
                            🔄 Atualizar Dashboard
                        </button>
                    </div>
                    
                    <div class="commands-info">
                        <h3>📱 Comandos WhatsApp</h3>
                        <div class="commands-grid">
                            <span class="command">saldo</span>
                            <span class="command">hoje</span>
                            <span class="command">exportar</span>
                            <span class="command">deletar</span>
                            <span class="command">ajuda</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="footer">
            <p>🤖 Bot WhatsApp - Controle de Gastos | <span id="lastUpdate"></span></p>
        </footer>
    </div>
    
    <script>
        // Dados para os gráficos
        const categoryData = {
            labels: [{% for categoria in gastos_por_categoria.keys() %}'{{ categoria.title() }}'{% if not loop.last %},{% endif %}{% endfor %}],
            values: [{% for valor in gastos_por_categoria.values() %}{{ valor }}{% if not loop.last %},{% endif %}{% endfor %}]
        };
        
        const productsData = {
            labels: [{% for produto in produtos_mais_gastos.keys() %}'{{ produto.title() }}'{% if not loop.last %},{% endif %}{% endfor %}],
            values: [{% for valor in produtos_mais_gastos.values() %}{{ valor }}{% if not loop.last %},{% endif %}{% endfor %}]
        };
        
        // Cores para tema dark
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
            '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
        ];
        
        // Gráfico de Pizza - Categorias
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categoryData.labels,
                datasets: [{
                    data: categoryData.values,
                    backgroundColor: colors,
                    borderColor: '#2C3E50',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#ECF0F1',
                            padding: 20,
                            font: { size: 12 }
                        }
                    }
                }
            }
        });
        
        // Gráfico de Barras - Produtos
        const productsCtx = document.getElementById('productsChart').getContext('2d');
        new Chart(productsCtx, {
            type: 'bar',
            data: {
                labels: productsData.labels,
                datasets: [{
                    label: 'Valor Gasto (R$)',
                    data: productsData.values,
                    backgroundColor: colors[0],
                    borderColor: colors[0],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#ECF0F1',
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2);
                            }
                        },
                        grid: {
                            color: '#34495E'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#ECF0F1',
                            maxRotation: 45
                        },
                        grid: {
                            color: '#34495E'
                        }
                    }
                }
            }
        });
        
        // Auto-refresh e data/hora
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR');
            document.getElementById('lastUpdate').textContent = 'Última atualização: ' + dateStr;
        });
        
        // Auto-refresh a cada 5 minutos
        setTimeout(() => {
            location.reload();
        }, 300000);
    </script>
</body>
</html>